<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>李华卿&#39;s Home | 声讯平台V1.1改造梳理</title>
    <meta name="description" content="李华卿&#39;s Home">
    
    
    <link rel="preload" href="/assets/css/13.styles.6bc8c6d0.css" as="style"><link rel="preload" href="/assets/js/app.4d07fc9d.js" as="script"><link rel="preload" href="/assets/js/8.2aeb774c.js" as="script"><link rel="prefetch" href="/assets/js/7.c8bb1d74.js"><link rel="prefetch" href="/assets/js/1.1f3708cf.js"><link rel="prefetch" href="/assets/js/2.cf3a80ad.js"><link rel="prefetch" href="/assets/js/3.f92948b9.js"><link rel="prefetch" href="/assets/js/4.02a59966.js"><link rel="prefetch" href="/assets/js/5.82eaf450.js"><link rel="prefetch" href="/assets/js/6.584cd904.js"><link rel="prefetch" href="/assets/js/0.03b1b08c.js"><link rel="prefetch" href="/assets/js/9.bc65ed26.js"><link rel="prefetch" href="/assets/js/10.522b477b.js"><link rel="prefetch" href="/assets/js/11.942e6fb3.js"><link rel="prefetch" href="/assets/js/12.b5f3f157.js">
    <link rel="stylesheet" href="/assets/css/13.styles.6bc8c6d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      李华卿's Home
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">个人简介</a></div><div class="nav-item"><a href="/share.html" class="nav-link">分享</a></div><div class="nav-item"><a href="/design.html" class="nav-link">梳理与设计</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">个人简介</a></div><div class="nav-item"><a href="/share.html" class="nav-link">分享</a></div><div class="nav-item"><a href="/design.html" class="nav-link">梳理与设计</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>声讯平台V1.1改造梳理</span><!----></p><ul class="sidebar-group-items"><li><a href="/design3.html#一、1-0梳理" class="sidebar-link">一、1.0梳理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design3.html#_1-0链条结构" class="sidebar-link">1.0链条结构:</a></li><li class="sidebar-sub-header"><a href="/design3.html#_1-0流程：" class="sidebar-link">1.0流程：</a></li><li class="sidebar-sub-header"><a href="/design3.html#_1-0er图" class="sidebar-link">1.0ER图:</a></li><li class="sidebar-sub-header"><a href="/design3.html#_1-0遗留的问题" class="sidebar-link">1.0遗留的问题</a></li></ul></li><li><a href="/design3.html#二、1-1改进设计" class="sidebar-link">二、1.1改进设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/design3.html#_1-领域模型拆分" class="sidebar-link">1.领域模型拆分</a></li><li class="sidebar-sub-header"><a href="/design3.html#_2-代码结构整理" class="sidebar-link">2.代码结构整理</a></li><li class="sidebar-sub-header"><a href="/design3.html#_3-分布式执行任务单一一致性问题需优化" class="sidebar-link">3.分布式执行任务单一一致性问题需优化</a></li><li class="sidebar-sub-header"><a href="/design3.html#_4-接口性能优化，响应时间从300ms压缩到100ms以内" class="sidebar-link">4.接口性能优化，响应时间从300ms压缩到100ms以内</a></li><li class="sidebar-sub-header"><a href="/design3.html#_5-风控报警设计" class="sidebar-link">5.风控报警设计</a></li><li class="sidebar-sub-header"><a href="/design3.html#_6-提供部分运营可操作配置" class="sidebar-link">6.提供部分运营可操作配置</a></li><li class="sidebar-sub-header"><a href="/design3.html#_7-设计业务指标及精细化打点" class="sidebar-link">7.设计业务指标及精细化打点</a></li></ul></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="声讯平台v1-1改造梳理"><a href="#声讯平台v1-1改造梳理" aria-hidden="true" class="header-anchor">#</a> 声讯平台V1.1改造梳理</h1><h2 id="一、1-0梳理"><a href="#一、1-0梳理" aria-hidden="true" class="header-anchor">#</a> 一、1.0梳理</h2><h3 id="_1-0链条结构"><a href="#_1-0链条结构" aria-hidden="true" class="header-anchor">#</a> 1.0链条结构:</h3><img src="img1/d3-1.png"><h3 id="_1-0流程："><a href="#_1-0流程：" aria-hidden="true" class="header-anchor">#</a> 1.0流程：</h3><img src="img1/d3-2.png"><p></p><h3 id="_1-0er图"><a href="#_1-0er图" aria-hidden="true" class="header-anchor">#</a> 1.0ER图:</h3><img src="img1/d3-3.png"><h3 id="_1-0遗留的问题"><a href="#_1-0遗留的问题" aria-hidden="true" class="header-anchor">#</a> 1.0遗留的问题</h3><p>1.分布式执行任务单一一致性问题需优化</p><p></p><h2 id="二、1-1改进设计"><a href="#二、1-1改进设计" aria-hidden="true" class="header-anchor">#</a> 二、1.1改进设计</h2><h3 id="_1-领域模型拆分"><a href="#_1-领域模型拆分" aria-hidden="true" class="header-anchor">#</a> 1.领域模型拆分</h3><img src="img1/d3-4.png"><h3 id="_2-代码结构整理"><a href="#_2-代码结构整理" aria-hidden="true" class="header-anchor">#</a> 2.代码结构整理</h3><p>编写完成时优化，主要针对RetryAction进行拆分重构</p><h3 id="_3-分布式执行任务单一一致性问题需优化"><a href="#_3-分布式执行任务单一一致性问题需优化" aria-hidden="true" class="header-anchor">#</a> 3.分布式执行任务单一一致性问题需优化</h3><p>分片后根据ivr_call.id进行所得分片进行hash，原加锁逻辑不变防止一个call多次呼出。</p><h3 id="_4-接口性能优化，响应时间从300ms压缩到100ms以内"><a href="#_4-接口性能优化，响应时间从300ms压缩到100ms以内" aria-hidden="true" class="header-anchor">#</a> 4.接口性能优化，响应时间从300ms压缩到100ms以内</h3><p>针对长链条中的数据多次查询进行优化、缓存。</p><p>费时较高的非必要操作异步化。</p><p>优化数据结构，添加部分冗余字段，减少db请求</p><h3 id="_5-风控报警设计"><a href="#_5-风控报警设计" aria-hidden="true" class="header-anchor">#</a> 5.风控报警设计</h3><table><thead><tr><th>现象</th><th style="text-align:center">规则</th><th style="text-align:right">响应</th></tr></thead><tbody><tr><td>无法触达</td><td style="text-align:center">同一POI M天内超过N次未接听</td><td style="text-align:right">告知订单此情况禁止部分下单 or 通过拒单隐藏逻辑</td></tr><tr><td>按键无反应</td><td style="text-align:center">同一POI M天内超过N次接听超过S秒，但没有按键</td><td style="text-align:right">切换外呼线路或切换服务商重新呼叫</td></tr><tr><td>多次拒单</td><td style="text-align:center">同一POI M天内连续N次以上拒单</td><td style="text-align:right">拒单隐藏逻辑 或 更重大惩罚措施（in order）?</td></tr><tr><td>服务商故障</td><td style="text-align:center">同一Provider M分钟内连续调用API异常N次以上</td><td style="text-align:right">降低该服务商权重为1(1%)，待确认恢复后，手工修改权重</td></tr><tr><td>系统故障</td><td style="text-align:center">falcon监控</td><td style="text-align:right">火线救援</td></tr></tbody></table><h3 id="_6-提供部分运营可操作配置"><a href="#_6-提供部分运营可操作配置" aria-hidden="true" class="header-anchor">#</a> 6.提供部分运营可操作配置</h3><p><strong>设置商家电话线路</strong></p><p><strong>设置城市电话线路</strong></p><p><strong>配置TTS模板信息</strong></p><p><strong>配置服务商权重</strong></p><p></p><h3 id="_7-设计业务指标及精细化打点"><a href="#_7-设计业务指标及精细化打点" aria-hidden="true" class="header-anchor">#</a> 7.设计业务指标及精细化打点</h3><table><thead><tr><th>现象</th><th style="text-align:center">规则</th><th style="text-align:right">响应</th></tr></thead><tbody><tr><td>CALL_OUT</td><td style="text-align:center">执行呼叫</td><td style="text-align:right">transaction</td></tr><tr><td>CALL_LOCKED</td><td style="text-align:center">加锁准备开始呼叫</td><td style="text-align:right">event</td></tr><tr><td>CALL_CREATE_TTS</td><td style="text-align:center">生成模板动态信息</td><td style="text-align:right">event</td></tr><tr><td>CALL_EXECUTE</td><td style="text-align:center">第三方执行呼叫成功</td><td style="text-align:right">event</td></tr><tr><td>CALL_NO_RESPONSE</td><td style="text-align:center">呼叫未接听</td><td style="text-align:right">metric</td></tr><tr><td>CALL_NO_PRESS</td><td style="text-align:center">呼叫没有按键</td><td style="text-align:right">metric</td></tr><tr><td>CALL_RESPONSE_SUCCESS</td><td style="text-align:center">呼叫完成</td><td style="text-align:right">metric</td></tr><tr><td>CALL_ORDER_ACCEPT</td><td style="text-align:center">声讯接单</td><td style="text-align:right">metric</td></tr><tr><td>CALL_ORDER_REFUSE</td><td style="text-align:center">声讯拒单</td><td style="text-align:right">metric</td></tr><tr><td>CALL_RECHECK_SUCCESS</td><td style="text-align:center">声讯复核成功</td><td style="text-align:right">metric</td></tr></tbody></table><p></p><p>8.天润回调接口优化</p><p>select * from ivr_call where status = 10 limit 100;</p><p>上线以来，共15条被锁住没有释放的call，其中一条可能为执行外呼时重启（时间较早，日志不好排查），14条因为没有收到回调，没收到回调的原因有：天润故障、cc机器重启</p><p>处理方案为:</p><pre><code>与天润沟融，务必添加重试机制

收到消息第一时间暂存，失败后重试

处理因意外情况未收到回调的call(监控长时间上锁的call)

修改重试策略为每5秒重试，重试10次</code></pre></div><!----><!----></div></div></div>
    <script src="/assets/js/8.2aeb774c.js" defer></script><script src="/assets/js/app.4d07fc9d.js" defer></script>
  </body>
</html>
