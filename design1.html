<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>李华卿&#39;s Home | 声讯平台设计201703</title>
    <meta name="description" content="李华卿&#39;s Home">
    
    
    <link rel="preload" href="/assets/css/17.styles.1e39e98b.css" as="style"><link rel="preload" href="/assets/js/app.ead676ba.js" as="script"><link rel="preload" href="/assets/js/14.751337b4.js" as="script"><link rel="prefetch" href="/assets/js/9.1069f795.js"><link rel="prefetch" href="/assets/js/1.b9e5ce15.js"><link rel="prefetch" href="/assets/js/2.c4f5c3cb.js"><link rel="prefetch" href="/assets/js/3.352ef2d1.js"><link rel="prefetch" href="/assets/js/4.29f4bcfb.js"><link rel="prefetch" href="/assets/js/5.11f49897.js"><link rel="prefetch" href="/assets/js/6.02d19890.js"><link rel="prefetch" href="/assets/js/7.99f9bf61.js"><link rel="prefetch" href="/assets/js/8.e96e59d6.js"><link rel="prefetch" href="/assets/js/0.7c96950e.js"><link rel="prefetch" href="/assets/js/10.0b4d89e5.js"><link rel="prefetch" href="/assets/js/11.b43da688.js"><link rel="prefetch" href="/assets/js/12.0bf43118.js"><link rel="prefetch" href="/assets/js/13.9a581397.js"><link rel="prefetch" href="/assets/js/15.2ba46b8f.js"><link rel="prefetch" href="/assets/js/16.5478534b.js">
    <link rel="stylesheet" href="/assets/css/17.styles.1e39e98b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      李华卿's Home
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">个人简介</a></div><div class="nav-item"><a href="/share.html" class="nav-link">分享</a></div><div class="nav-item"><a href="/design.html" class="nav-link">梳理与设计</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">个人简介</a></div><div class="nav-item"><a href="/share.html" class="nav-link">分享</a></div><div class="nav-item"><a href="/design.html" class="nav-link">梳理与设计</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>声讯平台设计201703</span><!----></p><ul class="sidebar-group-items"><li><a href="/design1.html#_1-概述" class="sidebar-link">1.概述</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/design1.html#_2-er图" class="sidebar-link">2.ER图</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/design1.html#_3-数据库设计" class="sidebar-link">3.数据库设计</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/design1.html#_4-功能概览" class="sidebar-link">4.功能概览</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/design1.html#_5-关键功能详细设计" class="sidebar-link">5.关键功能详细设计</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="声讯平台设计201703"><a href="#声讯平台设计201703" aria-hidden="true" class="header-anchor">#</a> 声讯平台设计201703</h1><h2 id="_1-概述"><a href="#_1-概述" aria-hidden="true" class="header-anchor">#</a> 1.概述</h2><p><strong>背景</strong></p><p>IVR(Interactive Voice Response)即互动式语音应答，是一种功能强大的电话自动服务系统。它用预先录制或TTS文本转语音技术合成的语音进行自动应答，提供一种为客户进行菜单导航的功能。您只须调用外呼接口或呼入的方式即可进入服务中心，可以根据语音文件收听播放的提示音，也可以根据用户输入的内容播放语音信息。</p><p>IVR声讯服务是餐饮、酒旅预定业务重要的通知渠道之一，从之前rs-cc-web设计和使用过程中发现了一些问题有待完善。</p><p></p><p><strong>本次系统设计主要解决以下问题：</strong></p><p>1）以声讯平台为中心，外接多家IVR服务商，同时利用自身的健康检查机制，提高声讯服务高可用。</p><p>2）将呼叫服务与调度服务解耦。</p><p><strong>服务依赖</strong><img src="img1/d1-1.png"></p><p></p><p><strong>重要功能流程</strong></p><p>1）订单通知声讯服务流程</p><img src="img1/d1-2.png"><p>2）声讯服务与第三方交互过程</p><img src="img1/d1-3.png"><h2 id="_2-er图"><a href="#_2-er图" aria-hidden="true" class="header-anchor">#</a> 2.ER图</h2><img src="img1/d1-4.png"><h2 id="_3-数据库设计"><a href="#_3-数据库设计" aria-hidden="true" class="header-anchor">#</a> 3.数据库设计</h2><h2 id="_4-功能概览"><a href="#_4-功能概览" aria-hidden="true" class="header-anchor">#</a> 4.功能概览</h2><p>1）配置：商家权重配置、开关配置、根据配置进行分流</p><p>2）构建：事件树构建，对外暴露CCEventTemplateEnum枚举类，并根据Template生成CalloutEvent</p><p>3）呼出：scheduler触发callout，每个provider对应一个calloutServiceImpl 和 factory，cc内callout失败重试。</p><p>4）回调：每个provider对应一个callbackServiceImpl 和 factory，按照事件树进行，记录结果，并完成外部回调。</p><h2 id="_5-关键功能详细设计"><a href="#_5-关键功能详细设计" aria-hidden="true" class="header-anchor">#</a> 5.关键功能详细设计</h2><p>callTrigger分配 → 单机处理callTrigger → dispatch解释callrule→ call → 等待回调(成功)/job(失败)</p><p>1）集群内callTrigger分配</p><p>1.按pigeon负载均衡策略接收task的机器完成自身trigger处理流程,增加重试job将未处理的task重新请求分配</p><p>2）单机callTrigger处理流程</p><img src="img1/d1-5.png"><p></p><p>3）callcenter内分流dispatch设计</p><img src="img1/d1-6.png"><p>依次校验 服务降级开关（restrict rule）、poiCallRule、cityCallRule 来判断callTrigger是否产生call，provider是哪个。如果没有适配到provider则使用权重策略分流：</p><p>1.库存式，根据权重生成总计1W（MCC配置，可以影响健康检查反馈实时性）个call库存，打乱后，放入tair中，每次call消耗库存（待确定tair的原子性，不过影响不大）</p><p>2.实时根据权重随机分配</p><p></p><p>4)job设计</p><p>a.trigger触发call job  1min/次</p><p>select * from trigger where send_time &gt; now() and status = 'not send' and handler = 'self';</p><p>查询到达预约时间并且还未处理的自己trigger , 触发call</p><p></p><p>b.trigger锁释放job  1min/次</p><img src="img1/d1-7.png"><p></p><p>c.health monitor job 1min/次</p><p>统计call的count(success)、count(fail)、count(nopress) group by provider</p><p>update provider_weight by provider_weight_threshold</p><p>weight只减按比例减不增，达到阈值时，降低weight，发送邮件、大象，与第三方确认恢复后人工恢复</p><p></p><p></p></div><!----><!----></div></div></div>
    <script src="/assets/js/14.751337b4.js" defer></script><script src="/assets/js/app.ead676ba.js" defer></script>
  </body>
</html>
